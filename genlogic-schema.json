{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://genlogic.dev/schema/v1",
  "title": "GenLogic Schema",
  "description": "GenLogic YAML schema for Augmented Normalization - Foreign keys are DATA PIPELINES that create columns AND automation pathways",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "columns": {
      "type": "object",
      "description": "Reusable column definitions that can be inherited and overridden in table definitions",
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_]*$": {
          "$ref": "#/definitions/columnDefinition"
        }
      },
      "additionalProperties": false
    },
    "tables": {
      "type": "object",
      "description": "Table definitions with foreign keys as named data pipelines",
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_]*$": {
          "$ref": "#/definitions/tableDefinition",
          "title": "Valid PostgreSQL table name",
          "description": "Must start with letter or underscore, followed by letters, numbers, or underscores"
        }
      },
      "additionalProperties": false
    }
  },
  "definitions": {
    "columnDefinition": {
      "type": "object",
      "description": "Column definition with type, constraints, and optional automation",
      "properties": {
        "type": {
          "type": "string",
          "description": "PostgreSQL column type (e.g., integer, varchar, numeric)"
        },
        "size": {
          "type": "integer",
          "minimum": 1,
          "description": "Size parameter for types that support it (e.g., varchar size)"
        },
        "decimal": {
          "type": "integer",
          "minimum": 0,
          "description": "Decimal places for numeric types (only valid when size is present)"
        },
        "primary_key": {
          "type": "boolean",
          "description": "Whether this column is part of the primary key"
        },
        "unique": {
          "type": "boolean",
          "description": "Whether this column has a unique constraint"
        },
        "sequence": {
          "type": "boolean",
          "description": "Whether to create a sequence for this column (auto-increment)"
        },
        "automation": {
          "$ref": "#/definitions/automationDefinition",
          "description": "GENLOGIC CORE: Automation that references FK names, not table names"
        },
        "calculated": {
          "type": "string",
          "description": "SQL expression for calculated column (e.g., 'column1 + column2'). Mutually exclusive with automation."
        },
        "ui-notes": {
          "type": "array",
          "description": "UI guidance notes for this column",
          "items": {
            "type": "string",
            "enum": ["read-only", "hidden"],
            "description": "UI behavior hints: read-only (not editable), hidden (don't show in UI)"
          }
        }
      },
      "required": ["type"],
      "dependencies": {
        "decimal": ["size"]
      },
      "not": {
        "required": ["automation", "calculated"]
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "enum": ["varchar", "char", "bit"]
              }
            }
          },
          "then": {
            "required": ["size"]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "enum": ["date", "timestamp", "timestamptz", "boolean", "bool", "integer", "int", "int4", "bigint", "int8", "smallint", "int2", "real", "float4", "double precision", "float8", "text", "uuid", "json", "jsonb"]
              }
            }
          },
          "then": {
            "not": {
              "anyOf": [
                { "required": ["size"] },
                { "required": ["decimal"] }
              ]
            }
          }
        }
      ]
    },
    "tableColumnDefinition": {
      "description": "Table column with mixed inheritance: empty object (inherit same name), string (inherit named), object with $ref (inherit + override)",
      "oneOf": [
        {
          "type": "null",
          "description": "Null/empty value - inherit from reusable column of same name"
        },
        {
          "type": "string",
          "description": "String value - inherit from named reusable column (for renaming)",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
        },
        {
          "type": "object",
          "description": "Object with $ref - inherit from reusable column and override properties",
          "properties": {
            "$ref": {
              "type": "string",
              "description": "Name of reusable column to inherit from - VALIDATION REQUIRED: Must exist in top-level 'columns' section",
              "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
            },
            "type": {
              "type": "string",
              "description": "Override PostgreSQL column type"
            },
            "size": {
              "type": "integer",
              "minimum": 1,
              "description": "Override size parameter"
            },
            "decimal": {
              "type": "integer",
              "minimum": 0,
              "description": "Override decimal places"
            },
            "primary_key": {
              "type": "boolean",
              "description": "Override primary key setting"
            },
            "unique": {
              "type": "boolean",
              "description": "Override unique constraint"
            },
            "sequence": {
              "type": "boolean",
              "description": "Override sequence setting"
            },
            "automation": {
              "$ref": "#/definitions/automationDefinition",
              "description": "Override or add automation"
            },
            "calculated": {
              "type": "string",
              "description": "Override or add calculated expression"
            },
            "ui-notes": {
              "type": "array",
              "description": "Override or add UI guidance notes",
              "items": {
                "type": "string",
                "enum": ["read-only", "hidden"]
              }
            }
          },
          "required": ["$ref"],
          "additionalProperties": false,
          "not": {
            "required": ["automation", "calculated"]
          }
        },
        {
          "$ref": "#/definitions/columnDefinition",
          "description": "Full column definition (no inheritance)"
        }
      ]
    },
    "tableDefinition": {
      "type": "object",
      "description": "Table definition with foreign keys as named data pipelines",
      "properties": {
        "ui-notes": {
          "type": "array",
          "description": "UI guidance notes - not processed by database, expanded in resolved schema",
          "items": {
            "type": "string",
            "enum": ["singleton", "no-insert", "no-update", "no-delete"],
            "description": "UI behavior hints: singleton (expect 1 row), no-insert/update/delete (disable CRUD operations)"
          }
        },
        "sync": {
          "type": "object",
          "description": "GENLOGIC: Synchronize this table's rows to other tables via triggers",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "$ref": "#/definitions/syncDefinition"
            }
          },
          "additionalProperties": false
        },
        "spread": {
          "type": "object",
          "description": "GENLOGIC: Generate multiple rows in target table based on date range and interval",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "$ref": "#/definitions/spreadDefinition"
            }
          },
          "additionalProperties": false
        },
        "columns": {
          "type": "object",
          "description": "Column definitions - can inherit from reusable columns or define inline",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "$ref": "#/definitions/tableColumnDefinition"
            }
          },
          "additionalProperties": false
        },
        "foreign_keys": {
          "type": "object",
          "description": "GENLOGIC CORE: Named data pipelines that create columns AND automation pathways",
          "additionalProperties": {
            "$ref": "#/definitions/foreignKeyDefinition"
          }
        },
        "content": {
          "type": "array",
          "description": "Seed data rows to insert if not already present (checked by primary key)",
          "items": {
            "type": "object",
            "description": "Row data as key-value pairs matching column names. Values can be literals or $lookup objects for foreign key resolution.",
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": false
    },
    "foreignKeyDefinition": {
      "type": "object",
      "description": "GENLOGIC: Foreign key as named data pipeline - creates columns and defines automation paths",
      "properties": {
        "table": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
          "description": "Target table name - VALIDATION REQUIRED: Must exist in 'tables' section"
        },
        "prefix": {
          "type": "string",
          "description": "Prefix for created column names"
        },
        "suffix": {
          "type": "string",
          "description": "Suffix for created column names"
        },
        "delete": {
          "type": "string",
          "enum": ["restrict", "cascade"],
          "description": "Foreign key delete behavior"
        }
      },
      "required": ["table"]
    },
    "automationDefinition": {
      "type": "object",
      "description": "GENLOGIC PRINCIPLE: Automations specify explicit data flow pathways",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["SUM", "COUNT", "MAX", "MIN", "LATEST", "SNAPSHOT", "FOLLOW", "DOMINANT", "QUEUEPOS"],
          "description": "Type of automation"
        },
        "table": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
          "description": "Source table name for the automation - VALIDATION REQUIRED: Must exist in 'tables' section"
        },
        "foreign_key": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
          "description": "GENLOGIC CORE: FK name within the source table - VALIDATION REQUIRED: Must exist in specified table's foreign_keys section"
        },
        "column": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
          "description": "Source column name for the automation"
        }
      },
      "required": ["type", "table", "foreign_key", "column"]
    },
    "syncDefinition": {
      "type": "object",
      "description": "GENLOGIC: Synchronize rows from this table to another table via triggers",
      "properties": {
        "direction": {
          "type": "string",
          "enum": ["push", "pull", "bidirectional"],
          "description": "Direction of synchronization: push (to target), pull (from target), bidirectional (both)",
          "default": "push"
        },
        "operations": {
          "type": "array",
          "description": "Which operations trigger synchronization",
          "items": {
            "type": "string",
            "enum": ["insert", "update", "delete"]
          },
          "default": ["insert", "update", "delete"]
        },
        "match_columns": {
          "type": "object",
          "description": "Columns that identify the row relationship (always propagated on INSERT/UPDATE). Maps source columns to target columns.",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "type": "string",
              "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
              "description": "Source column mapped to target column (e.g., id: source_id)"
            }
          },
          "minProperties": 1
        },
        "match_conditions": {
          "type": "array",
          "description": "Optional SQL WHERE conditions for matching (e.g., \"batch = 'OPENING'\"). Only used in WHERE clause, not propagated.",
          "items": {
            "type": "string",
            "description": "SQL condition string"
          }
        },
        "column_map": {
          "type": "object",
          "description": "Data columns to sync (not used for row matching). Maps source columns to target columns.",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "type": "string",
              "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
              "description": "Source column name mapped to target column name"
            }
          }
        },
        "literals": {
          "type": "object",
          "description": "Constant values to set in target table (only on INSERT)",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "type": "string",
              "description": "Target column name and literal value to set"
            }
          }
        }
      },
      "required": ["match_columns"]
    },
    "spreadDefinition": {
      "type": "object",
      "description": "GENLOGIC: Generate multiple rows in target table based on date range and interval",
      "properties": {
        "operations": {
          "type": "array",
          "description": "Which operations trigger spread generation",
          "items": {
            "type": "string",
            "enum": ["insert", "update", "delete"]
          },
          "default": ["insert", "update", "delete"]
        },
        "generate": {
          "type": "object",
          "description": "Date range and interval configuration for generating rows",
          "properties": {
            "start_date": {
              "type": "string",
              "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
              "description": "Column name containing the start date"
            },
            "end_date": {
              "type": "string",
              "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
              "description": "Column name containing the end date"
            },
            "interval": {
              "type": "string",
              "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
              "description": "Column name containing the interval (PostgreSQL interval value)"
            }
          },
          "required": ["start_date", "end_date", "interval"]
        },
        "column_map": {
          "type": "object",
          "description": "Data columns to copy to generated rows",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "type": "string",
              "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
              "description": "Source column name mapped to target column name"
            }
          }
        },
        "literals": {
          "type": "object",
          "description": "Constant values to set in all generated rows",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "type": "string",
              "description": "Target column name and literal value to set"
            }
          }
        },
        "tracking_column": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
          "description": "FK column in target table that points back to source (for tracking generated rows)"
        }
      },
      "required": ["generate", "tracking_column"]
    }
  }
}